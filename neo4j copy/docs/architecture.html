<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Purple Fabric — Technical Architecture Document</title>
<style>
  :root {
    --purple: #6B21A8;
    --purple-light: #7C3AED;
    --purple-bg: #F5F3FF;
    --border: #E5E7EB;
    --text: #1F2937;
    --text-secondary: #6B7280;
    --bg: #FFFFFF;
    --code-bg: #F8F9FA;
    --success: #059669;
    --warning: #D97706;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    color: var(--text);
    line-height: 1.7;
    max-width: 1100px;
    margin: 0 auto;
    padding: 40px 32px;
    background: var(--bg);
  }
  h1 { font-size: 28px; color: var(--purple); margin-bottom: 8px; border-bottom: 3px solid var(--purple); padding-bottom: 12px; }
  h2 { font-size: 22px; color: var(--purple); margin-top: 48px; margin-bottom: 16px; border-bottom: 1px solid var(--border); padding-bottom: 8px; }
  h3 { font-size: 17px; color: var(--purple-light); margin-top: 32px; margin-bottom: 12px; }
  p { margin-bottom: 12px; }
  .meta { color: var(--text-secondary); font-size: 14px; margin-bottom: 32px; }
  .meta strong { color: var(--text); }
  pre {
    background: #1E1E2E;
    color: #CDD6F4;
    padding: 20px;
    border-radius: 8px;
    overflow-x: auto;
    font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
    font-size: 12.5px;
    line-height: 1.5;
    margin: 16px 0;
    border: 1px solid #313244;
  }
  code {
    background: var(--code-bg);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
    font-size: 13px;
    color: var(--purple);
  }
  pre code { background: none; padding: 0; color: inherit; }
  table {
    width: 100%;
    border-collapse: collapse;
    margin: 16px 0;
    font-size: 14px;
  }
  th {
    background: var(--purple-bg);
    color: var(--purple);
    font-weight: 600;
    text-align: left;
    padding: 10px 14px;
    border: 1px solid var(--border);
  }
  td {
    padding: 10px 14px;
    border: 1px solid var(--border);
    vertical-align: top;
  }
  tr:nth-child(even) td { background: #FAFAFA; }
  ul, ol { margin: 8px 0 16px 24px; }
  li { margin-bottom: 4px; }
  hr { border: none; border-top: 1px solid var(--border); margin: 40px 0; }
  .toc { background: var(--purple-bg); border: 1px solid var(--border); border-radius: 8px; padding: 20px 28px; margin: 24px 0; }
  .toc h3 { margin-top: 0; color: var(--purple); }
  .toc ol { margin: 8px 0 0 20px; }
  .toc li { margin-bottom: 4px; }
  .toc a { color: var(--purple); text-decoration: none; }
  .toc a:hover { text-decoration: underline; }
  @media print {
    body { max-width: 100%; padding: 20px; }
    pre { font-size: 10px; }
    h2 { page-break-before: always; }
  }
</style>
</head>
<body>

<h1>Purple Fabric — Technical Architecture Document</h1>
<div class="meta">
  <strong>Version:</strong> 2.0 &nbsp;|&nbsp;
  <strong>Date:</strong> February 2026 &nbsp;|&nbsp;
  <strong>Classification:</strong> Internal — Technical Leadership
</div>

<div class="toc">
<h3>Table of Contents</h3>
<ol>
  <li><a href="#exec">Executive Summary</a></li>
  <li><a href="#overview">System Architecture Overview</a></li>
  <li><a href="#databases">Database Responsibilities</a></li>
  <li><a href="#multitenant">Multi-Tenant Architecture</a></li>
  <li><a href="#auth">Authentication &amp; Authorization</a></li>
  <li><a href="#pipeline">Document Processing Pipeline</a></li>
  <li><a href="#sync">GraphDB → Neo4j Sync</a></li>
  <li><a href="#rag">Graph RAG Query Flow</a></li>
  <li><a href="#versioning">Ontology Versioning</a></li>
  <li><a href="#viz">Entity Visualization</a></li>
  <li><a href="#deploy">Deployment Architecture</a></li>
  <li><a href="#client">Client Architecture</a></li>
  <li><a href="#deps">Service Dependency Graph</a></li>
  <li><a href="#security">Security Architecture</a></li>
  <li><a href="#jobs">Background Job Processing</a></li>
  <li><a href="#decisions">Key Design Decisions</a></li>
</ol>
</div>

<hr>

<!-- Section 1: Executive Summary -->
<h2 id="exec">1. Executive Summary</h2>
<p>Purple Fabric is an enterprise-grade, multi-tenant knowledge graph platform that combines semantic web technologies (OWL/RDF/SPARQL), property graph analytics (Neo4j), vector embeddings (Redis), and AI-powered document processing (AWS Bedrock / OpenAI / Ollama) into a unified system for automated knowledge extraction, ontology management, and conversational graph querying.</p>
<p>The platform ingests structured (CSV/Excel) and unstructured (PDF/text) documents, extracts entities and relationships using LLM-powered pipelines, stores them as RDF triples in GraphDB with full ontology conformance, syncs to Neo4j for graph analytics and visualization, and provides a Graph RAG conversational interface for natural-language querying across the knowledge graph.</p>

<hr>

<!-- Section 2: System Architecture Overview -->
<h2 id="overview">2. System Architecture Overview</h2>
<pre><code>┌─────────────────────────────────────────────────────────────────────────┐
│                        CLIENT (React SPA)                               │
│  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌──────────┐ │
│  │ Knowledge │ │   Data    │ │ Ontology  │ │   Jobs    │ │  Admin   │ │
│  │ Assistant │ │Management │ │  Manager  │ │  Monitor  │ │  Panel   │ │
│  └─────┬─────┘ └─────┬─────┘ └─────┬─────┘ └─────┬─────┘ └────┬─────┘ │
└────────┼──────────────┼─────────────┼─────────────┼────────────┼────────┘
         │              │             │             │            │
         ▼              ▼             ▼             ▼            ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    NGINX REVERSE PROXY (Port 80/443)                    │
│                    SSL Termination · Static Assets                      │
└────────────────────────────────┬────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    EXPRESS.JS SERVER (Port 5002)                        │
│                                                                         │
│  ┌─── Middleware Stack ──────────────────────────────────────────────┐  │
│  │ CORS → JSON Parser → CSRF → Rate Limiter → Activity Logger      │  │
│  │ → JWT Auth → RBAC → Tenant Context                              │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  ┌─── API Routes ───────────────────────────────────────────────────┐  │
│  │ /api/auth      /api/owl         /api/sparql     /api/entities   │  │
│  │ /api/chat      /api/ontology/*  /api/graph      /api/evidence   │  │
│  │ /api/admin     /api/tenants     /api/metrics    /api/settings   │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  ┌─── Service Layer ────────────────────────────────────────────────┐  │
│  │ GraphRAGService    ExtractionService    OWLOntologyService      │  │
│  │ LLMService         ChunkingService      VersioningService       │  │
│  │ EntityService      EmbeddingService     GraphDBTripleService    │  │
│  │ SchemaAnalysis     DataProfileService   GraphDBNeo4jSyncService │  │
│  └──────────────────────────────────────────────────────────────────┘  │
└────────────┬──────────────────┬──────────────────┬──────────────────────┘
             │                  │                  │
             ▼                  ▼                  ▼
┌────────────────────┐ ┌────────────────┐ ┌────────────────────┐
│     GraphDB        │ │     Neo4j      │ │      Redis         │
│  (RDF Triplestore) │ │ (Property Graph│ │ (Vector Store +    │
│                    │ │  + Analytics)  │ │  Cache + Queue)    │
│  Port 7200         │ │  Port 7687     │ │  Port 6379         │
│                    │ │                │ │                    │
│ • Schema graphs    │ │ • Entity nodes │ │ • Vector embeddings│
│ • Data graphs      │ │ • Relationships│ │ • Staging data     │
│ • Audit graphs     │ │ • Graph viz    │ │ • Column mappings  │
│ • Deprecated graphs│ │ • BFS traversal│ │ • Ontology versions│
│ • Global ontologies│ │                │ │ • Session/auth     │
│ • SPARQL engine    │ │                │ │ • BullMQ queues    │
└────────────────────┘ └────────────────┘ └────────────────────┘</code></pre>

<hr>

<!-- Section 3: Database Responsibilities -->
<h2 id="databases">3. Database Responsibilities (Separation of Concerns)</h2>

<h3>3.1 GraphDB (Authoritative RDF Store)</h3>
<table>
  <tr><th>Concern</th><th>Details</th></tr>
  <tr><td>Role</td><td>Single source of truth for all semantic data</td></tr>
  <tr><td>Format</td><td>RDF triples in Turtle (TTL) syntax</td></tr>
  <tr><td>Query</td><td>SPARQL 1.1</td></tr>
  <tr><td>Isolation</td><td>Named graphs per tenant/workspace/ontology</td></tr>
</table>

<p>Named graph IRI patterns:</p>
<pre><code>Global ontology:     http://example.org/graphs/global/ontology/{ontologyId}
Workspace schema:    http://purplefabric.ai/graphs/tenant/{t}/workspace/{w}/schema
Workspace data:      http://purplefabric.ai/graphs/tenant/{t}/workspace/{w}/data
Audit graph:         http://purplefabric.ai/graphs/tenant/{t}/workspace/{w}/audit
Deprecated graph:    http://purplefabric.ai/graphs/tenant/{t}/workspace/{w}/deprecated</code></pre>

<p>What lives in GraphDB:</p>
<ul>
  <li>OWL ontology definitions (classes, object properties, datatype properties, restrictions)</li>
  <li>Entity instance triples (rdf:type, rdfs:label, properties, relationships)</li>
  <li>Document provenance (pf:sourceDocument links)</li>
  <li>Audit/change events (who changed what, when)</li>
  <li>Deprecated schema elements (accumulation graph, never cleared)</li>
</ul>

<h3>3.2 Neo4j (Serving / Analytics Graph)</h3>
<table>
  <tr><th>Concern</th><th>Details</th></tr>
  <tr><td>Role</td><td>Read-optimized property graph for visualization and traversal</td></tr>
  <tr><td>Query</td><td>Cypher</td></tr>
  <tr><td>Sync</td><td>One-way from GraphDB via <code>GraphDBNeo4jSyncService</code></td></tr>
  <tr><td>Scoping</td><td><code>tenant_id</code> + <code>workspace_id</code> properties on every node</td></tr>
</table>

<p>What lives in Neo4j:</p>
<ul>
  <li>Entity nodes with labels matching ontology classes</li>
  <li>Relationships matching ontology object properties</li>
  <li>Properties: <code>concept_id</code>, <code>tenant_id</code>, <code>workspace_id</code>, <code>name</code>, <code>label</code></li>
  <li>Used for: entity listing, graph visualization (BFS), relationship traversal</li>
</ul>

<h3>3.3 Redis (Vector Store + Cache + Queue)</h3>
<table>
  <tr><th>Concern</th><th>Details</th></tr>
  <tr><td>Role</td><td>Vector embeddings for RAG, staging area, cache, job queues</td></tr>
  <tr><td>Index</td><td>RediSearch HNSW (cosine similarity, 1024-dim)</td></tr>
  <tr><td>Persistence</td><td>AOF (append-only file)</td></tr>
</table>

<p>Key patterns:</p>
<pre><code>chunk:{chunkId}              → Vector embedding + text + metadata (permanent)
staged:{docId}               → Staging data for uncommitted documents (7-day TTL)
doc:{docId}                  → Committed document metadata (permanent)
colmap:{workspaceId}:{ontId} → Column mapping configuration (permanent)
colmap_history:{w}:{o}       → Mapping version history (permanent)
ontology_version:{ontId}:*   → Ontology version snapshots (permanent)
session:{token}              → User session data
bull:*                       → BullMQ job queues</code></pre>

<hr>

<!-- Section 4: Multi-Tenant Architecture -->
<h2 id="multitenant">4. Multi-Tenant Architecture</h2>
<pre><code>┌─────────────────────────────────────────────────────────────────┐
│                     GLOBAL ONTOLOGY LIBRARY                     │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐          │
│  │  Resume  │ │  Legal   │ │ Banking  │ │   AML    │          │
│  │ Ontology │ │ Contract │ │ Ontology │ │ Ontology │          │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘          │
│              (Read-only, shared across all tenants)             │
└─────────────────────────────┬───────────────────────────────────┘
                              │ fork / copy
          ┌───────────────────┼───────────────────┐
          ▼                   ▼                   ▼
┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐
│    Tenant A      │ │    Tenant B      │ │    Tenant C      │
│ ┌──────────────┐ │ │ ┌──────────────┐ │ │ ┌──────────────┐ │
│ │ Workspace 1  │ │ │ │ Workspace 1  │ │ │ │ Workspace 1  │ │
│ │ • Schema     │ │ │ │ • Schema     │ │ │ │ • Schema     │ │
│ │ • Data       │ │ │ │ • Data       │ │ │ │ • Data       │ │
│ │ • Audit      │ │ │ │ • Audit      │ │ │ │ • Audit      │ │
│ └──────────────┘ │ │ └──────────────┘ │ │ └──────────────┘ │
│ ┌──────────────┐ │ │ ┌──────────────┐ │ └──────────────────┘
│ │ Workspace 2  │ │ │ │ Workspace 2  │ │
│ │ • Schema     │ │ │ │ • Schema     │ │
│ │ • Data       │ │ │ │ • Data       │ │
│ └──────────────┘ │ │ └──────────────┘ │
└──────────────────┘ └──────────────────┘</code></pre>

<p>Isolation is enforced at every layer:</p>
<ul>
  <li><strong>GraphDB:</strong> Separate named graphs per tenant/workspace</li>
  <li><strong>Neo4j:</strong> <code>tenant_id</code> + <code>workspace_id</code> properties on every node, filtered in all Cypher queries</li>
  <li><strong>Redis:</strong> Key prefixes include workspace/tenant IDs</li>
  <li><strong>API:</strong> <code>X-Tenant-Id</code> and <code>X-Workspace-Id</code> headers required on all requests</li>
  <li><strong>Middleware:</strong> <code>tenantContext</code> middleware extracts and validates context before any route handler</li>
</ul>

<hr>

<!-- Section 5: Authentication & Authorization -->
<h2 id="auth">5. Authentication &amp; Authorization</h2>
<pre><code>┌──────────┐     ┌──────────────┐     ┌──────────────┐     ┌──────────┐
│  Client  │────▶│  CSRF Check  │────▶│  JWT Verify  │────▶│   RBAC   │
│ (Bearer) │     │ (X-Requested │     │  (Bearer     │     │ (Role +  │
│          │     │  -With hdr)  │     │   token)     │     │  Perms)  │
└──────────┘     └──────────────┘     └──────────────┘     └──────────┘
                                                                 │
                                                                 ▼
                                                          ┌──────────┐
                                                          │  Route   │
                                                          │ Handler  │
                                                          └──────────┘</code></pre>

<h3>Role Hierarchy</h3>
<table>
  <tr><th>Role</th><th>Inherits</th><th>Key Permissions</th></tr>
  <tr><td><code>viewer</code></td><td>—</td><td>Read dashboards, execute queries, use chat, read documents/entities</td></tr>
  <tr><td><code>member</code></td><td>viewer</td><td>Upload documents, run extractions, delete own content</td></tr>
  <tr><td><code>manager</code></td><td>member</td><td>Manage ontologies, clear data, manage folders, trigger sync</td></tr>
  <tr><td><code>admin</code></td><td>manager</td><td>Manage users/tenants, system settings, LLM config, purge</td></tr>
</table>

<h3>Token Flow</h3>
<pre><code>POST /api/auth/login { email, password }
  → Validate credentials
  → Generate JWT (24h expiry) + Refresh token (7d)
  → Return { token, refreshToken, user }

All subsequent requests:
  Authorization: Bearer &lt;jwt&gt;
  X-Requested-With: XMLHttpRequest  (CSRF protection)
  X-Tenant-Id: &lt;tenantId&gt;
  X-Workspace-Id: &lt;workspaceId&gt;</code></pre>

<hr>

<!-- Section 6: Document Processing Pipeline -->
<h2 id="pipeline">6. Document Processing Pipeline</h2>
<p>This is the core data ingestion flow. Documents go through a multi-stage pipeline from upload to committed knowledge graph data.</p>

<h3>6.1 Sequence Diagram — Document Upload &amp; Staging</h3>
<pre><code>┌──────┐     ┌──────────┐     ┌──────────┐     ┌───────┐     ┌───────┐
│Client│     │ Documents│     │ Parsers  │     │Chunker│     │ Redis │
│      │     │  Route   │     │PDF/CSV/  │     │       │     │       │
│      │     │          │     │Text      │     │       │     │       │
└──┬───┘     └────┬─────┘     └────┬─────┘     └───┬───┘     └───┬───┘
   │              │                │               │             │
   │ POST /upload │                │               │             │
   │ (multipart)  │                │               │             │
   │─────────────▶│                │               │             │
   │              │  Parse file    │               │             │
   │              │───────────────▶│               │             │
   │              │                │               │             │
   │              │  Parsed data   │               │             │
   │              │◀───────────────│               │             │
   │              │                │               │             │
   │              │  Chunk text    │               │             │
   │              │────────────────────────────────▶│             │
   │              │                │               │             │
   │              │  Chunks[]      │               │             │
   │              │◀────────────────────────────────│             │
   │              │                │               │             │
   │              │  Store staged:{docId}           │             │
   │              │──────────────────────────────────────────────▶│
   │              │                │               │  (7-day TTL)│
   │              │                │               │             │
   │  { docId,    │                │               │             │
   │    staged }  │                │               │             │
   │◀─────────────│                │               │             │</code></pre>

<h3>6.2 Sequence Diagram — Schema Analysis &amp; Ontology Creation</h3>
<pre><code>┌──────┐     ┌──────────┐     ┌─────────┐     ┌─────────┐     ┌───────┐
│Client│     │ Documents│     │ Schema  │     │   LLM   │     │GraphDB│
│      │     │  Route   │     │ Analyzer│     │ Service │     │       │
└──┬───┘     └────┬─────┘     └────┬────┘     └────┬────┘     └───┬───┘
   │              │                │               │             │
   │ POST /analyze│                │               │             │
   │─────────────▶│                │               │             │
   │              │  Analyze text  │               │             │
   │              │───────────────▶│               │             │
   │              │                │  LLM prompt:  │             │
   │              │                │  "Identify    │             │
   │              │                │   classes,    │             │
   │              │                │   properties, │             │
   │              │                │   relations"  │             │
   │              │                │──────────────▶│             │
   │              │                │               │             │
   │              │                │  Suggested    │             │
   │              │                │  schema       │             │
   │              │                │◀──────────────│             │
   │              │                │               │             │
   │              │  { classes,    │               │             │
   │              │    properties, │               │             │
   │              │    relations } │               │             │
   │              │◀───────────────│               │             │
   │              │                │               │             │
   │  Schema      │                │               │             │
   │  results     │                │               │             │
   │◀─────────────│                │               │             │
   │              │                │               │             │
   │ POST /owl    │  (User saves as ontology)      │             │
   │─────────────▶│                │               │             │
   │              │  Generate Turtle + import       │             │
   │              │──────────────────────────────────────────────▶│
   │              │                │               │  (schema    │
   │              │                │               │   graph)    │</code></pre>

<h3>6.3 Sequence Diagram — Column Mapping (CSV/Excel)</h3>
<pre><code>┌──────┐     ┌──────────────┐     ┌──────────┐     ┌───────┐
│Client│     │StagedDocument│     │ OWL      │     │ Redis │
│(SDR) │     │Review (UI)   │     │ Service  │     │       │
└──┬───┘     └──────┬───────┘     └────┬─────┘     └───┬───┘
   │               │                   │               │
   │ Select        │                   │               │
   │ ontology      │                   │               │
   │──────────────▶│                   │               │
   │               │ GET /owl/structure│               │
   │               │──────────────────▶│               │
   │               │                   │               │
   │               │ { classes,        │               │
   │               │   properties      │               │
   │               │   with domain }   │               │
   │               │◀──────────────────│               │
   │               │                   │               │
   │               │ GET /column-mappings              │
   │               │──────────────────────────────────▶│
   │               │                   │               │
   │               │ Saved mappings    │               │
   │               │ (or empty)        │               │
   │               │◀──────────────────────────────────│
   │               │                   │               │
   │ autoMapColumns│                   │               │
   │ (match cols   │                   │               │
   │  to ontology  │                   │               │
   │  properties,  │                   │               │
   │  resolve      │                   │               │
   │  rdfs:domain) │                   │               │
   │◀──────────────│                   │               │
   │               │                   │               │
   │ User edits:   │                   │               │
   │ • Property    │                   │               │
   │ • Links To    │                   │               │
   │ • Belongs To  │ ◀── NEW: domain   │               │
   │ • Skip        │     routing for   │               │
   │               │     literal props │               │
   │──────────────▶│                   │               │
   │               │                   │               │
   │               │ POST /column-mappings             │
   │               │──────────────────────────────────▶│
   │               │                   │  colmap:{w}:{o}</code></pre>

<p>Each column mapping entry:</p>
<pre><code>{
  "property": "http://example.org#branchName",
  "propertyLabel": "branchName",
  "linkedClass": "",
  "linkedClassLabel": "",
  "domain": "http://example.org#Branch",
  "domainLabel": "Branch",
  "ignore": false
}</code></pre>

<ul>
  <li><code>linkedClass</code> set → Object property (creates relationship to another entity)</li>
  <li><code>linkedClass</code> empty → Datatype property (literal value)</li>
  <li><code>domain</code> → Which entity class this literal belongs to (resolved from <code>rdfs:domain</code>)</li>
  <li>For multi-sheet Excel: <code>sheetClassMap</code> maps each sheet to a primary class</li>
</ul>

<h3>6.4 Sequence Diagram — Commit (Triple Generation &amp; Storage)</h3>
<pre><code>┌──────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌───────┐  ┌─────┐  ┌─────┐
│Client│  │ Documents│  │ Triple   │  │ Embedding│  │GraphDB│  │Redis│  │Neo4j│
│      │  │  Route   │  │ Service  │  │ Service  │  │       │  │     │  │     │
└──┬───┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └───┬───┘  └──┬──┘  └──┬──┘
   │           │              │             │            │         │        │
   │ POST      │              │             │            │         │        │
   │ /commit   │              │             │            │         │        │
   │──────────▶│              │             │            │         │        │
   │           │              │             │            │         │        │
   │           │ Load staged  │             │            │         │        │
   │           │ data         │             │            │         │        │
   │           │─────────────────────────────────────────────────▶│        │
   │           │              │             │            │         │        │
   │           │ Load ontology│             │            │         │        │
   │           │──────────────────────────────────────▶│         │        │
   │           │              │             │            │         │        │
   │           │ generateCSV  │             │            │         │        │
   │           │ Triples()    │             │            │         │        │
   │           │─────────────▶│             │            │         │        │
   │           │              │             │            │         │        │
   │           │              │ PASS 1: Build entity URIs          │        │
   │           │              │ (natural key detection,            │        │
   │           │              │  cross-sheet FK resolution)        │        │
   │           │              │             │            │         │        │
   │           │              │ PASS 2: Generate triples           │        │
   │           │              │ • rdf:type for each entity         │        │
   │           │              │ • Object props → link to entity    │        │
   │           │              │ • Literal props → domain routing   │        │
   │           │              │   (attach to correct entity based  │        │
   │           │              │    on rdfs:domain, not just row)   │        │
   │           │              │             │            │         │        │
   │           │  triples[]   │             │            │         │        │
   │           │◀─────────────│             │            │         │        │
   │           │              │             │            │         │        │
   │           │ POST triples (Turtle)      │            │         │        │
   │           │──────────────────────────────────────▶│         │        │
   │           │              │             │  (data     │         │        │
   │           │              │             │   graph)   │         │        │
   │           │              │             │            │         │        │
   │           │ Embed chunks │             │            │         │        │
   │           │─────────────────────────▶│            │         │        │
   │           │              │             │            │         │        │
   │           │              │  Store vectors           │         │        │
   │           │              │  ──────────────────────────────▶│        │
   │           │              │             │            │         │        │
   │           │ Store doc metadata         │            │         │        │
   │           │─────────────────────────────────────────────────▶│        │
   │           │              │             │            │  doc:{id}        │
   │           │              │             │            │         │        │
   │           │ Save column mappings       │            │         │        │
   │           │─────────────────────────────────────────────────▶│        │
   │           │              │             │            │ colmap: │        │
   │           │              │             │            │         │        │
   │           │ Trigger sync │             │            │         │        │
   │           │ (GraphDB → Neo4j)          │            │         │        │
   │           │──────────────────────────────────────────────────────────▶│
   │           │              │             │            │         │        │
   │  { success,│             │             │            │         │        │
   │    jobId } │             │             │            │         │        │
   │◀──────────│              │             │            │         │        │</code></pre>

<h3>6.5 Domain-Aware Property Routing</h3>
<p>When committing CSV/Excel data, literal properties are routed to the correct entity based on <code>rdfs:domain</code>:</p>
<pre><code>CSV Row: BranchID=BR001, BranchName="Downtown", CustomerID=CUST001, FullName="Brian Brown"

Mapping:
  BranchID   → linkedClass: Branch    (object property → creates Branch:BR001)
  BranchName → literal, domain: Branch (attach to Branch:BR001, NOT Customer)
  CustomerID → linkedClass: Customer   (object property → creates Customer:CUST001)
  FullName   → literal, domain: ""     (attach to row entity = Customer)

Generated Triples:
  Customer:CUST001  rdf:type        Customer .
  Customer:CUST001  hasBranch       Branch:BR001 .
  Customer:CUST001  fullName        "Brian Brown" .
  Branch:BR001      rdf:type        Branch .
  Branch:BR001      branchName      "Downtown" .     ← routed to Branch, not Customer</code></pre>

<p>Resolution algorithm:</p>
<ol>
  <li>Check <code>mapping.domain</code> for the literal column</li>
  <li>If domain class ≠ row entity class → scan other columns in same row</li>
  <li>Find a column with <code>linkedClass</code> matching the domain class</li>
  <li>Use that column's value to resolve the target entity URI via <code>idLookup</code></li>
  <li>Attach the literal triple to the resolved entity</li>
</ol>

<hr>

<!-- Section 7: GraphDB → Neo4j Sync -->
<h2 id="sync">7. GraphDB → Neo4j Sync</h2>
<pre><code>┌───────┐                    ┌──────────────────┐                    ┌─────┐
│GraphDB│                    │GraphDBNeo4jSync  │                    │Neo4j│
│       │                    │Service           │                    │     │
└───┬───┘                    └────────┬─────────┘                    └──┬──┘
    │                                 │                                 │
    │  SPARQL: SELECT all instances   │                                 │
    │  from data graph                │                                 │
    │◀────────────────────────────────│                                 │
    │                                 │                                 │
    │  Bindings (batches of 10000)    │                                 │
    │────────────────────────────────▶│                                 │
    │                                 │                                 │
    │                                 │ PASS 1: Create/merge nodes      │
    │                                 │ (concept_id, labels, properties,│
    │                                 │  tenant_id, workspace_id)       │
    │                                 │────────────────────────────────▶│
    │                                 │                                 │
    │  SPARQL: SELECT all             │                                 │
    │  relationships from data graph  │                                 │
    │◀────────────────────────────────│                                 │
    │                                 │                                 │
    │  Relationship bindings          │                                 │
    │────────────────────────────────▶│                                 │
    │                                 │                                 │
    │                                 │ PASS 2: Create relationships    │
    │                                 │ (two directed queries to avoid  │
    │                                 │  ASTCachedProperty bug)         │
    │                                 │────────────────────────────────▶│
    │                                 │                                 │
    │                                 │ Remove orphan nodes             │
    │                                 │ (in Neo4j but not in GraphDB)   │
    │                                 │────────────────────────────────▶│</code></pre>

<p>Key constraints:</p>
<ul>
  <li>Neo4j sessions cannot run concurrent queries — all operations are sequential <code>await</code></li>
  <li><code>properties()</code> function on collected nodes triggers internal ASTCachedProperty bug — avoided</li>
  <li><code>startNode(r)</code> / <code>endNode(r)</code> property access also triggers the bug — use two directed queries instead</li>
  <li>Sync runs on server startup and after each document commit</li>
</ul>

<hr>

<!-- Section 8: Graph RAG Query Flow -->
<h2 id="rag">8. Graph RAG Query Flow</h2>
<pre><code>┌──────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌───────┐  ┌─────┐  ┌─────┐
│Client│  │  Chat    │  │ GraphRAG │  │   LLM    │  │ Redis │  │Neo4j│  │GDB  │
│      │  │  Route   │  │ Service  │  │ Service  │  │Vector │  │     │  │     │
└──┬───┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └───┬───┘  └──┬──┘  └──┬──┘
   │           │              │             │            │         │        │
   │ POST /chat│              │             │            │         │        │
   │ { query,  │              │             │            │         │        │
   │   mode }  │              │             │            │         │        │
   │──────────▶│              │             │            │         │        │
   │           │  query()     │             │            │         │        │
   │           │─────────────▶│             │            │         │        │
   │           │              │             │            │         │        │
   │           │              │─── Mode Selection ───────────────────────────
   │           │              │                          │         │        │
   │           │              │ [RAG mode]               │         │        │
   │           │              │ Embed query              │         │        │
   │           │              │─────────────────────────▶│         │        │
   │           │              │ KNN search (top-K)       │         │        │
   │           │              │◀─────────────────────────│         │        │
   │           │              │                          │         │        │
   │           │              │ [Graph mode]             │         │        │
   │           │              │ Traverse neighbors       │         │        │
   │           │              │──────────────────────────────────▶│        │
   │           │              │ Subgraph context         │         │        │
   │           │              │◀──────────────────────────────────│        │
   │           │              │                          │         │        │
   │           │              │ [SPARQL mode]            │         │        │
   │           │              │ LLM generates SPARQL     │         │        │
   │           │              │─────────────▶│           │         │        │
   │           │              │              │ Execute   │         │        │
   │           │              │              │──────────────────────────▶│
   │           │              │              │◀──────────────────────────│
   │           │              │◀─────────────│           │         │        │
   │           │              │                          │         │        │
   │           │              │ [Cypher mode]            │         │        │
   │           │              │ LLM generates Cypher     │         │        │
   │           │              │─────────────▶│           │         │        │
   │           │              │              │ Execute   │         │        │
   │           │              │              │─────────────────▶│        │
   │           │              │              │◀─────────────────│        │
   │           │              │◀─────────────│           │         │        │
   │           │              │                          │         │        │
   │           │              │ Merge context + LLM answer         │        │
   │           │              │─────────────▶│           │         │        │
   │           │              │◀─────────────│           │         │        │
   │           │              │             │            │         │        │
   │  { answer,│              │             │            │         │        │
   │    sources,│             │             │            │         │        │
   │    query } │             │             │            │         │        │
   │◀──────────│              │             │            │         │        │</code></pre>

<p>Query modes:</p>
<table>
  <tr><th>Mode</th><th>Sources</th><th>Best For</th></tr>
  <tr><td><code>rag</code></td><td>Vector search only</td><td>Free-text questions about document content</td></tr>
  <tr><td><code>graph</code></td><td>Neo4j traversal only</td><td>Entity relationship questions</td></tr>
  <tr><td><code>neo4j-direct</code></td><td>LLM-generated Cypher</td><td>Complex graph pattern queries</td></tr>
  <tr><td><code>graphdb-direct</code></td><td>LLM-generated SPARQL</td><td>Semantic/ontology-aware queries</td></tr>
  <tr><td><code>hybrid</code></td><td>Vector + Graph combined</td><td>General questions (default)</td></tr>
  <tr><td><code>compare</code></td><td>All sources side-by-side</td><td>Debugging / comparison</td></tr>
</table>

<hr>

<!-- Section 9: Ontology Versioning -->
<h2 id="versioning">9. Ontology Versioning</h2>
<pre><code>┌──────────────────────────────────────────────────────────────────┐
│                    Ontology Lifecycle                             │
│                                                                  │
│  Create ──▶ Edit ──▶ Version ──▶ Branch ──▶ Tag ──▶ Restore    │
│                                                                  │
│  Storage: Redis (single source of truth)                         │
│  GraphDB: ONE version per ontology (latest) in schema graph      │
│  Version snapshots: Redis at ontology_version:{ontId}:{verId}    │
└──────────────────────────────────────────────────────────────────┘</code></pre>

<pre><code>                    main branch
                    ┌─────────────────────────────────────────┐
                    │                                         │
                    v1 ──── v2 ──── v3 ──── v4 (HEAD)        │
                    │       │                                 │
                    │       └──── experimental branch          │
                    │             v2.1 ──── v2.2              │
                    │                                         │
                    tag: "initial" (v1)                        │
                    tag: "production-2026-02" (v3)             │
                    └─────────────────────────────────────────┘</code></pre>

<ul>
  <li>First version auto-tagged as <code>initial</code> on <code>main</code> branch</li>
  <li>Branches work like Git checkout — one active at a time per ontology</li>
  <li>Each committed document records <code>ontology_version_id</code> it was committed against</li>
  <li>Mapping staleness detection: compares mapping's <code>ontologyVersionId</code> against current version</li>
  <li>Impact analysis: shows which classes/properties were added/removed between versions</li>
</ul>

<hr>

<!-- Section 10: Entity Visualization -->
<h2 id="viz">10. Entity Visualization</h2>
<pre><code>┌──────┐     ┌──────────┐     ┌──────────┐     ┌─────┐
│Client│     │ Entity   │     │ Entity   │     │Neo4j│
│Graph │     │  Route   │     │ Service  │     │     │
│View  │     │          │     │          │     │     │
└──┬───┘     └────┬─────┘     └────┬─────┘     └──┬──┘
   │              │                │               │
   │ GET /graph   │                │               │
   │ ?depth=2     │                │               │
   │─────────────▶│                │               │
   │              │ getEntityGraph │               │
   │              │───────────────▶│               │
   │              │                │               │
   │              │                │ BFS traversal  │
   │              │                │ (depth levels) │
   │              │                │───────────────▶│
   │              │                │               │
   │              │                │ Two directed   │
   │              │                │ queries per    │
   │              │                │ level (avoid   │
   │              │                │ ASTCached bug) │
   │              │                │◀──────────────│
   │              │                │               │
   │              │ { nodes[],     │               │
   │              │   edges[] }    │               │
   │              │◀───────────────│               │
   │              │                │               │
   │  Render SVG  │                │               │
   │  • Concentric ring layout    │               │
   │  • Labels inside nodes       │               │
   │  • Directed arrows           │               │
   │  • Curved parallel edges     │               │
   │◀─────────────│                │               │</code></pre>

<p>Node IDs use composite format: <code>class::rawId</code> (e.g., <code>Customer::CUST000010</code>) to prevent collisions between different entity types sharing the same concept_id.</p>

<hr>

<!-- Section 11: Deployment Architecture -->
<h2 id="deploy">11. Deployment Architecture</h2>
<pre><code>┌─────────────────────────────────────────────────────────────────────┐
│                        Docker Compose Stack                         │
│                                                                     │
│  ┌──────────┐                                                       │
│  │  nginx   │ ◀── Port 80/443 (public)                             │
│  │ (reverse │     SSL termination, static assets                    │
│  │  proxy)  │                                                       │
│  └────┬─────┘                                                       │
│       │                                                             │
│       ▼                                                             │
│  ┌──────────┐     ┌──────────┐                                      │
│  │   app    │     │ workers  │                                      │
│  │ (Node.js │     │ (BullMQ  │                                      │
│  │  :5002)  │     │  procs)  │                                      │
│  └────┬─────┘     └────┬─────┘                                      │
│       │                │                                            │
│       ├────────────────┤                                            │
│       │                │                                            │
│       ▼                ▼                                            │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                          │
│  │ graphdb  │  │  neo4j   │  │  redis   │                          │
│  │ (10.7.3) │  │  (v5)    │  │ (7.4.0)  │                          │
│  │ :7200    │  │  :7687   │  │ :6379    │                          │
│  └──────────┘  └──────────┘  └──────────┘                          │
│       │              │             │                                │
│       ▼              ▼             ▼                                │
│  [graphdb_data] [neo4j_data] [redis_data]  ← Docker volumes        │
│                                                                     │
│  ┌──────────┐                                                       │
│  │ db-init  │ ← One-shot: creates GraphDB repo, Neo4j indexes,     │
│  │          │   Redis search index                                  │
│  └──────────┘                                                       │
└─────────────────────────────────────────────────────────────────────┘</code></pre>

<h3>Container Specifications</h3>
<table>
  <tr><th>Service</th><th>Image</th><th>Resources</th><th>Health Check</th></tr>
  <tr><td>graphdb</td><td>ontotext/graphdb:10.7.3</td><td>2GB heap</td><td>REST API <code>/rest/repositories</code></td></tr>
  <tr><td>neo4j</td><td>neo4j:5</td><td>Default</td><td><code>cypher-shell RETURN 1</code></td></tr>
  <tr><td>redis</td><td>redis/redis-stack-server:7.4.0-v2</td><td>AOF persistence</td><td><code>redis-cli ping</code></td></tr>
  <tr><td>app</td><td>iaikunal/enterprise-kg:latest</td><td>Node 18 Alpine</td><td>—</td></tr>
  <tr><td>workers</td><td>iaikunal/enterprise-kg:latest</td><td>Node 18 Alpine</td><td>—</td></tr>
  <tr><td>nginx</td><td>nginx:alpine</td><td>—</td><td>—</td></tr>
</table>

<hr>

<!-- Section 12: Client Architecture -->
<h2 id="client">12. Client Architecture</h2>
<pre><code>┌─────────────────────────────────────────────────────────────────┐
│                     React SPA (CRA)                             │
│                                                                 │
│  ┌─── Contexts ──────────────────────────────────────────────┐  │
│  │ AuthContext (JWT, login/logout, token refresh)             │  │
│  │ TenantContext (workspace selection, tenant headers)        │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌─── Hooks ─────────────────────────────────────────────────┐  │
│  │ useApi (fetch wrapper with auth headers)                   │  │
│  │ usePermissions (role-based UI gating)                      │  │
│  │ useOntologies (ontology list + selection)                  │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌─── Pages / Sections ──────────────────────────────────────┐  │
│  │                                                           │  │
│  │  💬 Knowledge Assistant (Chat)                            │  │
│  │     Graph RAG conversational interface                    │  │
│  │     Multiple query modes (RAG, Graph, SPARQL, Cypher)     │  │
│  │                                                           │  │
│  │  📁 Data Management                                       │  │
│  │     ├── FileManager (documents, chunks, entities, mapping)│  │
│  │     └── EntitiesPage (entity registry + graph view)       │  │
│  │                                                           │  │
│  │  📚 Ontologies                                            │  │
│  │     ├── OntologiesPage (list, create, import)             │  │
│  │     ├── EnhancedOntologyEditor (visual editor)            │  │
│  │     ├── EnhancedOntologyViewer (read-only view)           │  │
│  │     └── OntologyVersioningModal (version history)         │  │
│  │                                                           │  │
│  │  ⚙️ Jobs                                                  │  │
│  │     └── OntologyJobs (extraction, commit, analysis jobs)  │  │
│  │                                                           │  │
│  │  🔧 Administration                                        │  │
│  │     ├── DatabaseManager (Neo4j, GraphDB, Redis status)    │  │
│  │     ├── Users / Tenants / Roles management                │  │
│  │     ├── Audit Log (activity history)                      │  │
│  │     ├── LLM Monitor (token usage)                         │  │
│  │     └── Settings (system configuration)                   │  │
│  │                                                           │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘</code></pre>

<hr>

<!-- Section 13: Service Dependency Graph -->
<h2 id="deps">13. Service Dependency Graph</h2>
<pre><code>                        ┌─────────────────┐
                        │   llmService    │
                        │ (Bedrock/OpenAI/│
                        │  Ollama)        │
                        └────────┬────────┘
                                 │
          ┌──────────────────────┼──────────────────────┐
          │                      │                      │
          ▼                      ▼                      ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│ extractionSvc   │  │ graphRAGService │  │schemaAnalysisSvc│
│                 │  │                 │  │                 │
│ • chunkingSvc   │  │ • vectorStore   │  │ • llmService    │
│ • embeddingSvc  │  │ • neo4jService  │  │ • dataProfileSvc│
│ • conceptExtSvc │  │ • graphDBStore  │  └─────────────────┘
│ • entityResSvc  │  │ • llmService    │
│ • tripleService │  └─────────────────┘
└────────┬────────┘
         │
         ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│ graphDBTripleSvc│  │owlOntologySvc   │  │ entityService   │
│                 │  │                 │  │                 │
│ • graphDBStore  │  │ • graphDBStore  │  │ • neo4jService  │
│ • entityUriSvc  │  │ • versioningSvc │  │                 │
└─────────────────┘  └─────────────────┘  └─────────────────┘
         │                   │                      │
         ▼                   ▼                      ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│    GraphDB      │  │     Redis       │  │     Neo4j       │
│  (RDF Store)    │  │ (Vectors/Cache) │  │ (Property Graph)│
└─────────────────┘  └─────────────────┘  └─────────────────┘</code></pre>

<hr>

<!-- Section 14: Security Architecture -->
<h2 id="security">14. Security Architecture</h2>
<table>
  <tr><th>Layer</th><th>Mechanism</th></tr>
  <tr><td>Transport</td><td>HTTPS via nginx SSL termination (Let's Encrypt)</td></tr>
  <tr><td>Authentication</td><td>JWT Bearer tokens (24h expiry) + refresh tokens (7d)</td></tr>
  <tr><td>CSRF</td><td><code>X-Requested-With: XMLHttpRequest</code> header required on all state-changing requests</td></tr>
  <tr><td>Authorization</td><td>RBAC with 4-tier role hierarchy and 26 granular permissions</td></tr>
  <tr><td>Rate Limiting</td><td>200 requests/minute per user/IP on all <code>/api</code> routes</td></tr>
  <tr><td>Input Validation</td><td>LLM output validator, prompt sanitizer, Turtle syntax validation</td></tr>
  <tr><td>Audit</td><td>Activity logger captures all API requests with user, method, path, status</td></tr>
  <tr><td>Tenant Isolation</td><td>Named graphs (GraphDB), node properties (Neo4j), key prefixes (Redis)</td></tr>
  <tr><td>Data Scoping</td><td>Every query includes tenant/workspace filters — no cross-tenant data leakage</td></tr>
</table>

<hr>

<!-- Section 15: Background Job Processing -->
<h2 id="jobs">15. Background Job Processing</h2>
<pre><code>┌──────────────────────────────────────────────────────────────────┐
│                      BullMQ (Redis-backed)                       │
│                                                                  │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐     │
│  │  extraction    │  │   commit       │  │  schema-       │     │
│  │  queue         │  │   queue        │  │  analysis      │     │
│  │                │  │                │  │  queue         │     │
│  │ • Parse doc    │  │ • Gen triples  │  │ • LLM analyze  │     │
│  │ • LLM extract  │  │ • Store GraphDB│  │ • Suggest      │     │
│  │ • Embed chunks │  │ • Embed chunks │  │   classes      │     │
│  │ • Store vectors│  │ • Sync Neo4j   │  │ • Suggest      │     │
│  └────────────────┘  └────────────────┘  │   properties   │     │
│                                          └────────────────┘     │
│                                                                  │
│  Job lifecycle: pending → active → completed/failed              │
│  Progress updates via ontologyJobService                         │
│  UI polls OntologyJobs component for status                      │
└──────────────────────────────────────────────────────────────────┘</code></pre>

<hr>

<!-- Section 16: Key Design Decisions -->
<h2 id="decisions">16. Key Design Decisions</h2>
<table>
  <tr><th>Decision</th><th>Rationale</th></tr>
  <tr><td>GraphDB as source of truth</td><td>OWL/RDF provides formal semantics, reasoning, and SPARQL for complex queries</td></tr>
  <tr><td>Neo4j as serving layer</td><td>Optimized for graph traversal, visualization, and Cypher pattern matching</td></tr>
  <tr><td>Redis for vectors</td><td>RediSearch HNSW index provides sub-millisecond semantic search</td></tr>
  <tr><td>One-way sync (GraphDB → Neo4j)</td><td>Avoids dual-write consistency issues; GraphDB is authoritative</td></tr>
  <tr><td>Redis for ontology versions</td><td>Fast read/write for version snapshots; GraphDB stores only latest</td></tr>
  <tr><td>Staging in Redis with TTL</td><td>Uncommitted data auto-expires; no orphan cleanup needed</td></tr>
  <tr><td>Deterministic entity URIs</td><td>Natural key-based URIs enable cross-document entity deduplication</td></tr>
  <tr><td>Domain-aware property routing</td><td>Literal properties attach to the correct entity based on <code>rdfs:domain</code></td></tr>
  <tr><td>Composite node IDs (<code>class::rawId</code>)</td><td>Prevents collisions between different entity types sharing same concept_id</td></tr>
  <tr><td>Sequential Neo4j operations</td><td>Avoids ASTCachedProperty internal bug with concurrent session queries</td></tr>
</table>

<hr>

<p style="color: var(--text-secondary); font-size: 13px; margin-top: 40px;">
  <em>Document generated from codebase analysis. For API reference, see <code>/api-docs</code> (Swagger UI).</em>
</p>

</body>
</html>
